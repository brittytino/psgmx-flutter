â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ğŸš€ QUICK MIGRATION GUIDE                              â•‘
â•‘           Team Leader Task Verification - Database Setup                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ STEP 1: Go to Supabase Dashboard
   â†’ Open your project at https://supabase.com/dashboard
   â†’ Click "SQL Editor" in the left sidebar
   â†’ Click "New Query"

ğŸ“‹ STEP 2: Copy & Paste this Complete SQL Script:

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

-- Add verification columns
ALTER TABLE task_completions 
ADD COLUMN IF NOT EXISTS verified_by UUID REFERENCES users(id) ON DELETE SET NULL;

ALTER TABLE task_completions 
ADD COLUMN IF NOT EXISTS verified_at TIMESTAMPTZ;

-- Add indexes
CREATE INDEX IF NOT EXISTS idx_task_completions_verified_by 
ON task_completions(verified_by);

CREATE INDEX IF NOT EXISTS idx_task_completions_date_verified 
ON task_completions(task_date, verified_by);

-- Add RLS policies for team leaders
DROP POLICY IF EXISTS "Team leaders can insert team completions" ON task_completions;
CREATE POLICY "Team leaders can insert team completions"
ON task_completions FOR INSERT
WITH CHECK (
    EXISTS (
        SELECT 1 FROM users u1
        JOIN users u2 ON u1.team_id = u2.team_id
        WHERE u1.id = auth.uid()
        AND u2.id = task_completions.user_id
        AND (u1.roles->>'isTeamLeader')::boolean = true
    )
);

DROP POLICY IF EXISTS "Team leaders can update team completions" ON task_completions;
CREATE POLICY "Team leaders can update team completions"
ON task_completions FOR UPDATE
USING (
    EXISTS (
        SELECT 1 FROM users u1
        JOIN users u2 ON u1.team_id = u2.team_id
        WHERE u1.id = auth.uid()
        AND u2.id = task_completions.user_id
        AND (u1.roles->>'isTeamLeader')::boolean = true
    )
)
WITH CHECK (
    EXISTS (
        SELECT 1 FROM users u1
        JOIN users u2 ON u1.team_id = u2.team_id
        WHERE u1.id = auth.uid()
        AND u2.id = task_completions.user_id
        AND (u1.roles->>'isTeamLeader')::boolean = true
    )
);

-- Add admin policies
DROP POLICY IF EXISTS "Admins can insert all task completions" ON task_completions;
CREATE POLICY "Admins can insert all task completions"
ON task_completions FOR INSERT
WITH CHECK (
    EXISTS (
        SELECT 1 FROM users
        WHERE id = auth.uid()
        AND (
            (roles->>'isPlacementRep')::boolean = true
            OR (roles->>'isCoordinator')::boolean = true
        )
    )
);

DROP POLICY IF EXISTS "Admins can update all task completions" ON task_completions;
CREATE POLICY "Admins can update all task completions"
ON task_completions FOR UPDATE
USING (
    EXISTS (
        SELECT 1 FROM users
        WHERE id = auth.uid()
        AND (
            (roles->>'isPlacementRep')::boolean = true
            OR (roles->>'isCoordinator')::boolean = true
        )
    )
)
WITH CHECK (
    EXISTS (
        SELECT 1 FROM users
        WHERE id = auth.uid()
        AND (
            (roles->>'isPlacementRep')::boolean = true
            OR (roles->>'isCoordinator')::boolean = true
        )
    )
);

-- Verify
SELECT 
    column_name,
    data_type,
    is_nullable
FROM information_schema.columns
WHERE table_name = 'task_completions'
AND table_schema = 'public'
ORDER BY ordinal_position;

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ STEP 3: Click "Run" (or press Ctrl+Enter)

ğŸ“‹ STEP 4: Verify Success
   âœ… You should see a table with columns including "verified_by" and "verified_at"
   âœ… No error messages

ğŸ“‹ STEP 5: Test in the App
   1. Open the app as a team leader
   2. Go to Tasks â†’ Team Verification tab
   3. Try clicking "Completed" for a team member
   4. Should see green success message âœ…
   5. Blue "Verified" badge should appear

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ” TROUBLESHOOTING:

If you still get RLS error:
1. Check if you're logged in as a team leader
2. Verify team_id matches between leader and members
3. Run this to check policies:
   
   SELECT policyname, permissive, roles, cmd, qual 
   FROM pg_policies 
   WHERE tablename = 'task_completions';

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ Full migration script available at:
   database/MIGRATION_add_verification.sql

ğŸ“– Complete documentation at:
   database/MIGRATION_README.md

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
